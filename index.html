<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gobgob DEX</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
        <h1 class="text-center my-4">Gobgob Cards Collection</h1>
        
        <!-- Search Section -->
        <div class="search-box">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par pseudo...">
                <button class="btn btn-primary" onclick="searchCollection()">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
        </div>

        <!-- Collection Display -->
        <div id="collectionDisplay" class="collection-grid">
            <!-- Collection will be populated here -->
        </div>

        <!-- Cards List -->
        <div class="card-container">
            <h2>Toutes les cartes</h2>
            <div id="cardsList" class="collection-grid">
                <!-- Cards will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Variables pour stocker les données
        let allCards = [];
        let collectionData = [];

        // Charger les données au chargement de la page
        async function loadAllData() {
            try {
                // Charger les cartes
                const cardsResponse = await fetch('cards.csv');
                const cardsText = await cardsResponse.text();
                allCards = parseCSV(cardsText);

                // Charger la collection
                const collectionResponse = await fetch('collection.csv');
                const collectionText = await collectionResponse.text();
                collectionData = parseCSV(collectionText);

                // Afficher toutes les cartes
                displayAllCards();
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                alert('Erreur lors du chargement des données. Vérifiez que les fichiers CSV sont correctement formatés.');
            }
        }

        // Parser le CSV
        function parseCSV(csvText) {
            return csvText.trim().split('\n').map(row => {
                const [id, name, rarity] = row.split(',');
                return { id: parseInt(id), name, rarity };
            });
        }

        // Afficher toutes les cartes
        function displayAllCards() {
            const container = document.getElementById('cardsList');
            container.innerHTML = '';
            
            allCards.forEach(card => {
                const cardElement = createCardElement(card, false);
                container.appendChild(cardElement);
            });
        }

        // Créer un élément carte
        function createCardElement(card, isInCollection) {
            const div = document.createElement('div');
            div.className = `card ${isInCollection ? 'owned' : ''}`;
            div.innerHTML = `
                <img src="img/${card.id}.png" alt="${card.name}" class="card-image">
            `;
            return div;
        }

        // Rechercher la collection d'un joueur
        function searchCollection() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const collectionDisplay = document.getElementById('collectionDisplay');
            
            if (!searchTerm) {
                collectionDisplay.innerHTML = '<p class="no-cards">Veuillez entrer un pseudo.</p>';
                return;
            }

            // Filtrer la collection
            const userCards = collectionData
                .filter(row => row[0].toLowerCase() === searchTerm)
                .map(row => parseInt(row[1]));

            if (userCards.length === 0) {
                collectionDisplay.innerHTML = `<p class="no-cards">Aucune collection trouvée pour le pseudo "${searchTerm}".</p>`;
                return;
            }

            // Afficher toutes les cartes avec leur statut
            collectionDisplay.innerHTML = '';
            allCards.forEach(card => {
                const isInCollection = userCards.includes(card.id);
                const cardElement = createCardElement(card, isInCollection);
            });

            card.addEventListener("mouseleave", () => {
                card.querySelector('.card-inner').style.transform = "rotateX(0deg) rotateY(0deg)";
            });
        }

        function addZoomEffect(cardId) {
            const popup = document.getElementById("popup");
            const inner = document.getElementById("popup-inner");
            inner.style.backgroundImage = `url(img/${cardId}.png)`;
            popup.classList.add("visible");

            inner.addEventListener("mousemove", e => {
                const rect = inner.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = -(y - centerY) / 6;
                const rotateY = (x - centerX) / 6;
                inner.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
            });

            inner.addEventListener("mouseleave", () => {
                inner.style.transform = "rotateX(0deg) rotateY(0deg)";
            });
        }

        function hidePopup() {
            document.getElementById("popup").classList.remove("visible");
        }

        async function loadCollection() {
            const username = document.getElementById("username").value.toLowerCase();
            const collection = await fetchCollection();
            const owned = new Set(collection.filter(entry => entry.pseudo === username).map(entry => entry.id));
            const container = document.getElementById("cards");
            container.innerHTML = "";

            let index = 0;
            for (const card of allCards) {
                const div = document.createElement("div");
                div.className = "card";
                div.style.animationDelay = `${index * 50}ms`;

                const inner = document.createElement("div");
                inner.className = "card-inner";
                inner.style.backgroundImage = `url(img/${card.id}.png)`;
                inner.title = `${card.name} (${card.rarity})`;
                div.appendChild(inner);

                const isOwned = owned.has(card.id);
                if (!isOwned) {
                    div.classList.add("missing");
                    if (!showMissing) div.classList.add("hidden");
                } else {
                    addTiltEffect(div);
                    div.onclick = () => addZoomEffect(card.id);
                }

                container.appendChild(div);
                index++;
            }

            const ownedCount = owned.size;
            const totalCount = allCards.length || 1;
            const percent = (ownedCount / totalCount) * 100;
            document.getElementById("progress-text").textContent = `${ownedCount} carte${ownedCount !== 1 ? "s" : ""} débloquée${ownedCount !== 1 ? "s" : ""} sur ${totalCount}`;
            document.getElementById("progress-bar").style.width = percent + "%";
        }

        function toggleMissing() {
            showMissing = !showMissing;
            document.querySelectorAll(".card.missing").forEach(card => {
                card.classList.toggle("hidden", !showMissing);
            });
        }

        fetchCards().then(cards => allCards = cards);
    </script>
</body>
</html>
