<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pack Opening Synchronisé + Halo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #23282f; color: #fff; text-align: center; font-family: sans-serif; }
    .zone {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; width: 100vw;
    }
    .cardbox {
      position: relative; width: 320px; height: 480px; margin: 32px auto 0 auto;
      border-radius: 18px; box-shadow: 0 8px 40px #000c; background: #181c20; overflow: visible;
    }
    .card-img { width: 100%; height: 100%; border-radius: 18px; position: absolute; top:0; left:0; }
    .card-color {
      clip-path: inset(0 0 100% 0);
      transition: none;
      pointer-events: none;
      z-index: 2;
    }
    .card-bw {
      filter: grayscale(1) brightness(0.75) contrast(1.13);
      pointer-events: none;
      z-index: 1;
    }
    canvas {
      position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
    }
    .btn {
      margin-top: 16px; font-size: 1.25em; padding: 14px 34px; border-radius: 9px; border: none;
      background: linear-gradient(90deg, #fffcb7 15%, #ffd446 50%, #ffed99 85%);
      color: #302600; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 18px #0005;
      letter-spacing: 1.2px;
      transition: filter 0.15s;
    }
    .btn:active { filter: brightness(0.92); }
  </style>
</head>
<body>
<div class="zone">
  <div class="cardbox" id="cardbox">
    <img src="img/14.png" class="card-img card-bw" id="bw">
    <img src="img/14.png" class="card-img card-color" id="color">
    <canvas id="fx" width="320" height="480"></canvas>
  </div>
  <button class="btn" id="openBtn">Ouvrir la carte !</button>
</div>
<script>
const cardW = 320, cardH = 480;
const color = document.getElementById('color');
const openBtn = document.getElementById('openBtn');
const canvas = document.getElementById('fx');
const ctx = canvas.getContext('2d');
let animating = false;

function startAnim() {
  if (animating) return;
  animating = true;
  openBtn.disabled = true;
  openBtn.style.opacity = 0.7;
  color.style.clipPath = "inset(0 0 100% 0)";
  ctx.clearRect(0,0,cardW,cardH);

  let start = null;
  const duration = 1600;
  const borderParticles = [];
  const haloParticles = [];
  const maxHaloPerFrame = 7;

  function spawnHaloParticles() {
    // Particules "halo" du centre vers l'extérieur
    for (let i=0;i<maxHaloPerFrame;i++) {
      const a = Math.random()*2*Math.PI;
      const r0 = 80+Math.random()*30;
      const speed = 0.7+Math.random()*1.4;
      haloParticles.push({
        x: cardW/2, y: cardH/2+35,
        vx: Math.cos(a)*speed, vy: Math.sin(a)*speed,
        r: 1.5+Math.random()*1.1,
        color: "#fff",
        life: 0, maxLife: 60+Math.random()*25,
        glow: true
      });
    }
  }
  function drawParticles(list, localCtx) {
    for (let i=list.length-1;i>=0;i--) {
      const p = list[i];
      localCtx.save();
      if (p.glow) {
        localCtx.shadowColor = p.color;
        localCtx.shadowBlur = 13 + Math.random()*10;
      } else {
        localCtx.shadowBlur = 0;
      }
      localCtx.globalAlpha = Math.max(0.22, 1 - p.life/p.maxLife);
      localCtx.beginPath();
      localCtx.arc(p.x, p.y, p.r, 0, 2*Math.PI);
      localCtx.fillStyle = p.color;
      localCtx.fill();
      localCtx.globalAlpha = 1;
      localCtx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.life += 1;
      if (p.x < -10 || p.x > cardW+10 || p.y < -10 || p.y > cardH+30 || p.life > p.maxLife)
        list.splice(i,1);
    }
  }
  function spawnFrontParticles(frontY) {
    for (let i = 0; i < 100; i++) {
      const x = Math.random() * cardW;
      const y = frontY + (Math.random()-0.5)*18;
      const vx = (Math.random()-0.5)*1.2;
      const vy = 2.0 + Math.random()*2.2;
      const colorList = [
        "#fff", "#ffe066", "#fffbe6", "#9ffcff", "#f9f06b",
        "#fffb", "#fff9", "#ffe9", "#fffd", "#fcf5ff"
      ];
      const glowColor = colorList[Math.floor(Math.random()*colorList.length)];
      borderParticles.push({
        x: x,
        y: y,
        vx, vy,
        r: 2.7 + Math.random()*2.5,
        color: glowColor,
        life: 0,
        maxLife: 28 + Math.random()*18,
        glow: true
      });
    }
    // Quelques grosses étincelles
    for (let i=0; i<6; i++) {
      const x = Math.random() * cardW;
      borderParticles.push({
        x: x,
        y: frontY,
        vx: (Math.random()-0.5)*1.0, vy: 2.8 + Math.random()*1.6,
        r: 12 + Math.random()*11,
        color: "#fff",
        life: 0,
        maxLife: 19 + Math.random()*12,
        glow: true
      });
    }
  }
  function step(ts) {
    if (!start) start = ts;
    const progress = Math.min(1, (ts-start)/duration);
    const bottom = Math.round(cardH - cardH*progress);
    color.style.clipPath = `inset(0 0 ${bottom}px 0)`;
    ctx.clearRect(0,0,cardW,cardH);

    // Vibration
    const vib = Math.sin(progress*44)*4 + (Math.random()-0.5)*3.6;
    const rot = Math.sin(progress*31)*2.1 + (Math.random()-0.5)*1.0;
    document.getElementById('cardbox').style.transform = `translate(${vib}px, ${-vib/2}px) rotate(${rot}deg)`;

    // Halo
    spawnHaloParticles();
    drawParticles(haloParticles, ctx);

    // Particules de frontière
    const frontY = cardH - progress*cardH;
    spawnFrontParticles(frontY);
    drawParticles(borderParticles, ctx);

    if (progress < 1) {
      requestAnimationFrame(step);
    } else {
      color.style.clipPath = "none";
      document.getElementById('cardbox').style.transform = "";
      // Continue les particules jusqu'à disparition
      function finishParticles() {
        ctx.clearRect(0,0,cardW,cardH);
        let rest = borderParticles.length+haloParticles.length>0;
        drawParticles(haloParticles, ctx);
        drawParticles(borderParticles, ctx);
        if (rest) requestAnimationFrame(finishParticles);
        else {
          animating = false;
          openBtn.disabled = false;
          openBtn.style.opacity = 1;
        }
      }
      finishParticles();
    }
  }
  requestAnimationFrame(step);
}

openBtn.addEventListener("click", startAnim);
</script>
</body>
</html>
