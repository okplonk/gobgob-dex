<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Pack Opening Vertical Pluie - Carte 14</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #23282f; color: #fff; text-align: center; font-family: sans-serif; }
    .pack-opening-zone {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; width: 100vw;
    }
    .pack-opening-card {
      width: 320px; height: 480px; position: relative; overflow: hidden; border-radius: 18px; box-shadow: 0 8px 40px #000c;
      background: #181c20;
      margin: 32px auto 0 auto;
      user-select: none;
      transition: filter 0.18s;
      will-change: transform;
    }
    .card-bw, .card-color {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-size: contain; background-repeat: no-repeat; background-position: center;
      pointer-events: none;
    }
    .card-bw { filter: grayscale(1) brightness(0.75) contrast(1.13); }
    .card-color { transition: clip-path 0.3s; }
    #particle-canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
    }
    .open-btn {
      margin-top: 16px; font-size: 1.35em; padding: 14px 34px; border-radius: 9px; border: none;
      background: linear-gradient(90deg, #fffcb7 15%, #ffd446 50%, #ffed99 85%);
      color: #302600; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 18px #0005;
      letter-spacing: 1.5px;
      transition: filter 0.15s;
    }
    .open-btn:active { filter: brightness(0.93); }
    .title {
      margin-top: 24px;
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #000a;
    }
  </style>
</head>
<body>
  <div class="pack-opening-zone">
    <div class="title">Pack Opening Gobgob - Carte 14</div>
    <div class="pack-opening-card" id="packCard">
      <div class="card-bw" id="bw" style="background-image: url('img/14.png')"></div>
      <div class="card-color" id="color" style="background-image: url('img/14.png')"></div>
      <canvas id="particle-canvas" width="320" height="480"></canvas>
    </div>
    <button class="open-btn" id="openBtn">Ouvrir la carte !</button>
  </div>
<script>
const cardW = 320, cardH = 480;
const openBtn = document.getElementById('openBtn');
const color = document.getElementById('color');
const bw = document.getElementById('bw');
const card = document.getElementById('packCard');
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');

function startPackAnimation() {
  color.style.clipPath = "inset(0 0 100% 0)";
  canvas.width = cardW; canvas.height = cardH;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  let start = null;
  const duration = 1600; // ms
  const particles = [];
  let animDone = false;
  openBtn.disabled = true;
  openBtn.style.opacity = 0.65;

  // On va déterminer la vitesse de chute de la "frontière" : 
  // En px/ms
  const revealSpeed = cardH / duration;

  function spawnParticlesAtTop() {
    // Grosse pluie de particules brillantes au sommet à chaque frame
    for (let i = 0; i < 100; i++) {
      const x = Math.random() * cardW;
      // La vitesse de base = vitesse de révélation + variation random
      const baseVy = revealSpeed * (13 + Math.random() * 10); // un peu + rapide que la front
      const angle = (Math.random()-0.5)*Math.PI/9;
      const vx = Math.cos(angle) * (Math.random()*1.5); // petit écart latéral
      const vy = Math.abs(Math.sin(angle) * (Math.random()*1.2)) + baseVy;
      const colorList = [
        "#fff", "#ffe066", "#fffbe6", "#9ffcff", "#f9f06b",
        "#fffb", "#fff9", "#ffe9", "#fffd", "#fcf5ff"
      ];
      const glowColor = colorList[Math.floor(Math.random()*colorList.length)];
      particles.push({
        x: x,
        y: 0,
        vx, vy,
        r: 3.7 + Math.random()*2.5,
        color: glowColor,
        life: 0,
        maxLife: 18 + Math.random()*18,
        glow: true
      });
    }
    // Grosses "étincelles" (moins nombreuses)
    for (let i=0; i<8; i++) {
      const x = Math.random() * cardW;
      const vy = revealSpeed * (18 + Math.random()*10);
      particles.push({
        x: x, y: 0,
        vx: (Math.random()-0.5)*0.8, vy,
        r: 16 + Math.random()*14,
        color: "#fff",
        life: 0,
        maxLife: 15 + Math.random()*8,
        glow: true
      });
    }
  }

  function drawParticles() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for (let i=particles.length-1; i>=0; i--) {
      const p = particles[i];
      ctx.save();
      if (p.glow) {
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 16 + Math.random()*16;
      } else {
        ctx.shadowBlur = 0;
      }
      ctx.globalAlpha = Math.max(0.22, 1 - p.life/p.maxLife);
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, 2*Math.PI);
      ctx.fillStyle = p.color;
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.restore();

      p.x += p.vx;
      p.y += p.vy;
      p.life += 1;
      // On retire les particules SEULEMENT quand elles sont totalement sorties du cadre
      if (p.y > cardH + p.r*1.5 || p.life > p.maxLife) particles.splice(i, 1);
    }
  }

  function step(ts) {
    if (!start) start = ts;
    const progress = Math.min(1, (ts-start)/duration);
    const bottom = Math.round(cardH - cardH*progress);
    color.style.clipPath = `inset(0 0 ${bottom}px 0)`;

    // Vibration dynamique
    const vibration = Math.sin(progress*40)*4 + (Math.random()-0.5)*4;
    const rotate = Math.sin(progress*27)*2 + (Math.random()-0.5)*1.4;
    card.style.transform = `translate(${vibration}px, ${-vibration/2}px) rotate(${rotate}deg)`;

    // On génère les particules EN HAUT pendant toute la révélation
    if (!animDone) spawnParticlesAtTop();
    drawParticles();

    if (progress < 1) {
      requestAnimationFrame(step);
    } else {
      color.style.clipPath = "none";
      card.style.transform = ""; // stop vibration
      animDone = true;
      // Continue à dessiner les particules jusqu'à ce qu'il n'en reste plus
      function finishParticles() {
        drawParticles();
        if (particles.length > 0) {
          requestAnimationFrame(finishParticles);
        } else {
          openBtn.disabled = false;
          openBtn.style.opacity = 1;
        }
      }
      finishParticles();
    }
  }
  requestAnimationFrame(step);
}

openBtn.addEventListener("click", startPackAnimation);
</script>
</body>
</html>
